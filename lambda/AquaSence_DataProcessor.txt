import boto3
from decimal import Decimal
from datetime import datetime, timezone

dynamodb = boto3.resource("dynamodb")
sns = boto3.client("sns")

TABLE_NAME = "AquaSense_Readings"
TOPIC_ARN = "arn:aws:sns:ap-southeast-2:111810594268:AquaSense_Alerts"
table = dynamodb.Table(TABLE_NAME)

# Thresholds
AMMONIA_ALERT_PPM = 0.25

TEMP_MIN_C = 22.0
TEMP_MAX_C = 30.0

PH_MIN = 6.5
PH_MAX = 7.5


def _to_decimal(value) -> Decimal:
    return Decimal(str(value))


def lambda_handler(event, context):
    print("Incoming event:", event)

    # Required
    device_id = event["device_id"]

    # Generate timestamp as STRING because DynamoDB expects S
    timestamp = datetime.now(timezone.utc).isoformat()

    # Normalize
    temperature = float(event["temperature"])
    ph = float(event["ph"])
    ammonia = float(event["ammonia"])
    water_level = float(event["water_level"])

    # 1) Store telemetry
    item = {
        "device_id": device_id,
        "timestamp": timestamp,  # STRING key
        "temperature": _to_decimal(temperature),
        "ph": _to_decimal(ph),
        "ammonia": _to_decimal(ammonia),
        "water_level": _to_decimal(water_level),
    }

    table.put_item(Item=item)
    print(f"Saved reading: device_id={device_id}, timestamp={timestamp}")

    # 2) Alert logic
    issues = []

    if ammonia > AMMONIA_ALERT_PPM:
        issues.append(f"Ammonia high: {ammonia} ppm (limit {AMMONIA_ALERT_PPM})")

    if temperature < TEMP_MIN_C or temperature > TEMP_MAX_C:
        issues.append(f"Temperature out of range: {temperature} Â°C (safe {TEMP_MIN_C}-{TEMP_MAX_C})")

    if ph < PH_MIN or ph > PH_MAX:
        issues.append(f"pH out of range: {ph} (safe {PH_MIN}-{PH_MAX})")

    if issues:
        subject = f"AquaSense Alert - {device_id}"
        message = "\n".join([
            "AquaSense Alert",
            f"Device: {device_id}",
            f"Time (UTC): {timestamp}",
            "",
            "Detected issue(s):",
            *[f"- {x}" for x in issues],
            "",
            "Suggested actions:",
            "- If ammonia high: reduce feeding, remove uneaten food, check filter, partial water change",
            "- If pH out of range: test with kit, consider gradual correction (avoid sudden swings)",
            "- If temperature out of range: check heater/chiller/thermal regulator",
        ])

        resp = sns.publish(
            TopicArn=TOPIC_ARN,
            Subject=subject,
            Message=message,
        )
        print("Alert sent via SNS:", resp.get("MessageId"))
    else:
        print("Reading within thresholds; no alert sent.")

    return {"statusCode": 200, "body": "OK"}
