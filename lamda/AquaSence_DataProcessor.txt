import json
import boto3
from decimal import Decimal

# AWS clients/resources (created once per execution environment for efficiency)
dynamodb = boto3.resource("dynamodb")
sns = boto3.client("sns")

TABLE_NAME = "AquaSense_Readings"
TOPIC_ARN = "arn:aws:sns:ap-southeast-2:111810594268:AquaSense_Alerts"

table = dynamodb.Table(TABLE_NAME)

# Simple, explicit threshold values (easy to justify in report/demo)
AMMONIA_ALERT_PPM = 0.25
TEMP_MIN_C = 22.0
TEMP_MAX_C = 30.0


def _to_decimal(value) -> Decimal:
    """
    DynamoDB expects Decimal for numeric types.
    Using str() avoids float binary rounding issues.
    """
    return Decimal(str(value))


def lambda_handler(event, context):
    # Keep logs short but useful for debugging
    print("Incoming event:", event)

    # Required fields (assume present since IoT payload format is controlled by us)
    device_id = event["device_id"]
    timestamp = event["timestamp"]

    # Normalise values (convert to float once)
    temperature = float(event["temperature"])
    ph = float(event["ph"])
    ammonia = float(event["ammonia"])
    water_level = float(event["water_level"])

    # 1) Store every reading (telemetry)
    item = {
        "device_id": device_id,
        "timestamp": timestamp,
        "temperature": _to_decimal(temperature),
        "ph": _to_decimal(ph),
        "ammonia": _to_decimal(ammonia),
        "water_level": _to_decimal(water_level),
    }

    table.put_item(Item=item)
    print(f"Saved reading: device_id={device_id}, timestamp={timestamp}")

    # 2) Decide if we need to alert (only when something is out-of-range)
    issues = []

    if ammonia > AMMONIA_ALERT_PPM:
        issues.append(f"Ammonia high: {ammonia} ppm (limit {AMMONIA_ALERT_PPM})")

    if temperature < TEMP_MIN_C or temperature > TEMP_MAX_C:
        issues.append(f"Temperature out of range: {temperature} Â°C (safe {TEMP_MIN_C}-{TEMP_MAX_C})")

    # Add more later if you want (pH / water level), but B-grade is already met.

    if issues:
        subject = f"AquaSense Alert - {device_id}"
        message_lines = [
            "AquaSense Alert",
            f"Device: {device_id}",
            f"Time: {timestamp}",
            "",
            "Detected issue(s):",
            *[f"- {x}" for x in issues],
            "",
            "Suggested actions:",
            "- Check feeding amount (remove uneaten food)",
            "- Check filter performance",
            "- Consider a partial water change",
        ]

        resp = sns.publish(
            TopicArn=TOPIC_ARN,
            Subject=subject,
            Message="\n".join(message_lines),
        )
        print("Alert sent via SNS:", resp.get("MessageId"))
    else:
        print("Reading within thresholds; no alert sent.")

    return {"statusCode": 200, "body": "OK"}
